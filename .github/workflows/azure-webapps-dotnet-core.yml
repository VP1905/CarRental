# GitHub Actions Workflow
# Purpose:
# - Build and deploy the MaintainenceAPI (.NET Web API)
# - Automatically deploys to Azure App Service on every push
#   to the main branch

name: Build and deploy MaintainenceAPI to Azure Web App

# Workflow Triggers
# - Runs automatically when code is pushed to main branch
# - Can also be triggered manually from GitHub Actions UI
on:
  push:
    branches:
      - main
  workflow_dispatch:

# BUILD JOB
# - Restores dependencies
# - Builds the MaintainenceAPI project
# - Publishes output and stores it as an artifact
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Checkout the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup .NET SDK (version required by the project)
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      # Restore NuGet dependencies for the API project
      - name: Restore dependencies
        run: dotnet restore MaintainenceAPI/MaintainenceAPI.csproj

      # Build the project in Release configuration
      - name: Build project
        run: dotnet build MaintainenceAPI/MaintainenceAPI.csproj --configuration Release --no-restore

      # Publish the compiled output to a local folder
      - name: Publish project
        run: dotnet publish MaintainenceAPI/MaintainenceAPI.csproj -c Release -o publish
      
      # Upload published output as an artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: maintainenceapi
          path: publish
# DEPLOY 
  # - Downloads the build artifact
  # - Deploys the API to Azure App Service
  deploy:
    runs-on: ubuntu-latest
    needs: build

    # Download the published artifact from build job
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: maintainenceapi
      # Deploy the application to Azure Web App
      # Uses Azure Publish Profile stored securely in GitHub Secrets
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: maintenance-webapi-26
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
          package: .
